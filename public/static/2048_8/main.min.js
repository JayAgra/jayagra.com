function Tile(e,t){this.x=e.x,this.y=e.y,this.value=t,this.previousPosition=null,this.mergedFrom=null}function KeyboardInputManager(){this.events={},this.listen()}function getSize(){var e=new RegExp("(^|&)size=([^&]*)(&|$)","i"),t=location.search.substr(1).match(e);return null!=t?parseInt(unescape(decodeURI(t[2]))):8}function getMode(){var e=new RegExp("(^|&)mode=([^&]*)(&|$)","i"),t=location.search.substr(1).match(e);return null!=t?unescape(decodeURI(t[2])):"normal"}function doMovementPattern(e){void 0!==mover&&clearInterval(mover),mover=setInterval(e,50)}function stopMovement(){void 0!==mover&&(clearInterval(mover),mover=void 0)}function random(){game.move(Math.floor(4*Math.random()))}function changeRule(e,t,i){game.addRandomTile=function(){if(this.grid.cellsAvailable()){var t=new Tile(this.grid.randomAvailableCell(),e());this.grid.insertTile(t)}},game.tileMatchesAvailable=function(){for(var e,i=this,n=0;n<this.size;n++)for(var r=0;r<this.size;r++)if(e=this.grid.cellContent({x:n,y:r}))for(var o=0;o<4;o++){var a=i.getVector(o),s={x:n+a.x,y:r+a.y},l=i.grid.cellContent(s);if(l&&t(l.value,e.value))return!0}return!1},game.move=function(e){var n=this;if(!this.over&&!this.won){var r,o,a=this.getVector(e),s=this.buildTraversals(a),l=!1;this.prepareTiles(),s.x.forEach(function(e){s.y.forEach(function(s){if(r={x:e,y:s},o=n.grid.cellContent(r)){var c=n.findFarthestPosition(r,a),u=n.grid.cellContent(c.next);if(u&&!u.mergedFrom&&t(u.value,o.value)){var h=new Tile(c.next,o.value+u.value);h.mergedFrom=[o,u],n.grid.insertTile(h),n.grid.removeTile(o),o.updatePosition(c.next),n.score+=h.value,i(h.value)&&(n.won=!0)}else n.moveTile(o,c.farthest);n.positionsEqual(r,o)||(l=!0)}})}),l&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},game.inputManager.events.move=[],game.inputManager.on("move",game.move.bind(game)),game.restart()}function normalAdd(){return Math.random()<.9?2:4}function normalMerge(e,t){return e===t}function normalWin(e){return 4096===e}function normal(){changeRule(normalAdd,function(e,t){return e===t},function(e){return 2147483648===e})}function saveBoard(){tiles=[];for(var e=0;e<game.grid.cells.length;++e)for(var t=0;t<game.grid.cells[e].length;++t)game.grid.cells[e][t]&&tiles.push(game.grid.cells[e][t]);window.localStorage.setItem("tiles",JSON.stringify(tiles))}function loadBoard(){var e=window.localStorage.getItem("tiles");if(e){e=JSON.parse(e);for(i=0;i<game.grid.cells.length;++i)for(var t=0;t<game.grid.cells[i].length;++t)game.grid.cells[i][t]&&game.grid.removeTile(game.grid.cells[i][t]);for(var i=0;i<e.length;++i){var n=new Tile({x:e[i].x,y:e[i].y},e[i].value);game.grid.insertTile(n)}game.actuate()}}function loadSaved(){window.localStorage.getItem("tiles")&&loadBoard()}function Grid(e){this.size=e,this.cells=[],this.build()}function LocalScoreManager(){var e=!!window.localStorage;this.key="best8Score",this.storage=e?window.localStorage:window.fakeStorage}function GameManager(e,t,i,n){this.size=e,this.inputManager=new t,this.scoreManager=new n,this.actuator=new i,this.startTiles=4,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.setup()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(e){this.x=e.x,this.y=e.y},KeyboardInputManager.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},KeyboardInputManager.prototype.emit=function(e,t){var i=this.events[e];i&&i.forEach(function(e){e(t)})},KeyboardInputManager.prototype.listen=function(){var e=this,t={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(i){var n=i.altKey||i.ctrlKey||i.metaKey||i.shiftKey,r=t[i.which];n||(void 0!==r&&(i.preventDefault(),e.emit("move",r),saveBoard()),32===i.which&&e.restart.bind(e)(i))});var i=document.getElementsByClassName("retry-button")[0];i.addEventListener("click",this.restart.bind(this)),i.addEventListener("touchend",this.restart.bind(this));var n,r,o=document.getElementsByClassName("game-container")[0];o.addEventListener("touchstart",function(e){e.touches.length>1||(n=e.touches[0].clientX,r=e.touches[0].clientY,e.preventDefault())}),o.addEventListener("touchmove",function(e){e.preventDefault()}),o.addEventListener("touchend",function(t){if(!(t.touches.length>0)){var i=t.changedTouches[0].clientX-n,o=Math.abs(i),a=t.changedTouches[0].clientY-r,s=Math.abs(a);Math.max(o,s)>10&&e.emit("move",o>s?i>0?1:3:a>0?2:0)}})},KeyboardInputManager.prototype.restart=function(e){e.preventDefault(),this.emit("restart")};var game;window.requestAnimationFrame(function(){for(var e=getSize(),t=document.getElementById("grid-container"),i="",n=0;n<e;++n){i+='<div class="grid-row">';for(var r=0;r<e;++r)i+='<div class="grid-cell"></div>';i+="</div>"}t.innerHTML=i,game=new GameManager(e,KeyboardInputManager,HTMLActuator,LocalScoreManager)});var last="",dir=0,cnt=0,mover=void 0;setInterval(function(){tiles=[];for(var e=0;e<game.grid.cells.length;++e)for(var t=0;t<game.grid.cells[e].length;++t)game.grid.cells[e][t]&&tiles.push(game.grid.cells[e][t]);localStorage.setItem("tiles",JSON.stringify(tiles))},5e3),Grid.prototype.build=function(){for(var e=0;e<this.size;e++)for(var t=this.cells[e]=[],i=0;i<this.size;i++)t.push(null)},Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();if(e.length)return e[Math.floor(Math.random()*e.length)]},Grid.prototype.availableCells=function(){var e=[];return this.eachCell(function(t,i,n){n||e.push({x:t,y:i})}),e},Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++)for(var i=0;i<this.size;i++)e(t,i,this.cells[t][i])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)},Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)},Grid.prototype.cellContent=function(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null},Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e},Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null},Grid.prototype.withinBounds=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size},window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:void 0},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}},LocalScoreManager.prototype.get=function(){return this.storage.getItem(this.key)||0},LocalScoreManager.prototype.set=function(e){this.storage.setItem(this.key,e)},GameManager.prototype.restart=function(){this.actuator.restart(),this.setup()},GameManager.prototype.setup=function(){this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.addStartTiles(),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4,t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}},GameManager.prototype.actuate=function(){this.scoreManager.get()<this.score&&this.scoreManager.set(this.score),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,best8Score:this.scoreManager.get()})},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,i){i&&(i.mergedFrom=null,i.savePosition())})},GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null,this.grid.cells[t.x][t.y]=e,e.updatePosition(t)},GameManager.prototype.move=function(e){var t=this;if(!this.over&&!this.won){var i,n,r=this.getVector(e),o=this.buildTraversals(r),a=!1;this.prepareTiles(),o.x.forEach(function(e){o.y.forEach(function(o){if(i={x:e,y:o},n=t.grid.cellContent(i)){var s=t.findFarthestPosition(i,r),l=t.grid.cellContent(s.next);if(l&&l.value===n.value&&!l.mergedFrom){var c=new Tile(s.next,2*n.value);c.mergedFrom=[n,l],t.grid.insertTile(c),t.grid.removeTile(n),n.updatePosition(s.next),t.score+=c.value,2147483648===c.value&&(t.won=!0)}else t.moveTile(n,s.farthest);t.positionsEqual(i,n)||(a=!0)}})}),a&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(e){return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[e]},GameManager.prototype.buildTraversals=function(e){for(var t={x:[],y:[]},i=0;i<this.size;i++)t.x.push(i),t.y.push(i);return 1===e.x&&(t.x=t.x.reverse()),1===e.y&&(t.y=t.y.reverse()),t},GameManager.prototype.findFarthestPosition=function(e,t){var i;do{e={x:(i=e).x+t.x,y:i.y+t.y}}while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:i,next:e}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var e,t=this,i=0;i<this.size;i++)for(var n=0;n<this.size;n++)if(e=this.grid.cellContent({x:i,y:n}))for(var r=0;r<4;r++){var o=t.getVector(r),a={x:i+o.x,y:n+o.y},s=t.grid.cellContent(a);if(s&&s.value===e.value)return!0}return!1},GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y},HTMLActuator.prototype.actuate=function(e,t){var i=this;window.requestAnimationFrame(function(){i.clearContainer(i.tileContainer),e.cells.forEach(function(e){e.forEach(function(e){e&&i.addTile(e)})}),i.updateScore(t.score),i.updateBestScore(t.best8Score),t.over&&i.message(!1),t.won&&i.message(!0)})},HTMLActuator.prototype.restart=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},HTMLActuator.prototype.addTile=function(e){var t=this,i=document.createElement("div"),n=document.createElement("div"),r=e.previousPosition||{x:e.x,y:e.y};positionClass=this.positionClass(r);var o=["tile","tile-"+e.value,positionClass];this.applyClasses(i,o),n.classList.add("tile-inner"),n.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){o[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(i,o)}):e.mergedFrom?(o.push("tile-merged"),this.applyClasses(i,o),e.mergedFrom.forEach(function(e){t.addTile(e)})):(o.push("tile-new"),this.applyClasses(i,o)),i.appendChild(n),this.tileContainer.appendChild(i)},HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))},HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}},HTMLActuator.prototype.positionClass=function(e){return"tile-position-"+(e=this.normalizePosition(e)).x+"-"+e.y},HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,t>0){var i=document.createElement("div");i.classList.add("score-addition"),i.textContent="+"+t,this.scoreContainer.appendChild(i)}},HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e},HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over",i=e?"You win!":"Game over!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=i},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},function(){for(var e=0,t=["webkit","moz"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),o=window.setTimeout(function(){t(n+r)},r);return e=n+r,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();